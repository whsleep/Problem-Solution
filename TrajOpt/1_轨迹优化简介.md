# 什么是轨迹优化？

轨迹优化是用于找到最佳轨迹的一系列方法。

以卫星 🛰️ 在两颗行星间的运动为例，包含状态（如位置、速度）和控制（如推力）作为时间的函数；

轨迹优化通常通过选择系统的输入（即控制）作为时间的函数来实现。

## 预定义

$$
\begin{align}
&t_k & \quad节点 k 处时间\\
&N &\quad轨迹（样条）段数\\
&h_k=t_{k+1}-t_k &\quad样条段k的持续时间\\
&x_k=x(t_k) &\quad 节点 k 处状态\\
&u_k=u(t_k) &\quad 节点 k 处控制量\\
&\omega_k=\omega(t_k,x_k,u_k) &\quad 目标函数在节点 k 处被积函数\\
&f_k=f(t_k,x_k,u_k) &\quad 节点 k 处系统运动学方程\\
&\dot{q}=\frac{d}{dt}q,\ddot{q}=\frac{d^2}{st^2}q &\quad q的一阶导和二阶导
\end{align}
$$

在某些情况下，我们将使用下标 $k+\frac{1}{2}$ 来表示样条线段 $k$ 的中点。例如，$u_k$ 给出段 $k$ 开始处的控制，$u_{k+\frac{1}{2}}$ 给出段 $k$ 中点处的控制。

## 简单例子

**物块两点间移动的轨迹优化问题**

### 问题背景与动力学模型

我们以一个简单场景为研究对象：在固定时间内，让一个物块在两点之间移动，且要求物块在起点和终点时保持静止。

为分析这一问题，首先对物块进行动力学建模：

- 将物块简化为一维空间中移动的点；

- 系统的控制输入为施加在物块上的力；

- 用$x$表示物块的位置，$v$表示速度，$u$表示控制力，其动力学关系可描述为：

$$
\begin{align}
\dot{x}=v,\quad u=\dot{v}
\end{align}
$$

### 约束条件

针对 “1 秒内移动指定距离，且起点和终点静止” 的要求，该问题存在以下约束：

1.  **边界条件**：

$$
\begin{align}
x(0)=0,\quad x(1)=1\\
v(0)=0,\quad v(1)=0
\end{align}
$$

即物块初始位置为 0，1 秒后到达位置 1，且初始和最终速度均为 0。

2.  **运动学约束**：上述动力学关系 $\dot{x}=v$ 和 $u=\dot{v}$ 是物块运动必须遵循的基本规律。

在轨迹优化中，满足所有约束条件的解被称为**可行解**。

### 轨迹优化的核心：寻找最优轨迹

轨迹优化的目标是从所有可行解中找到**最优轨迹**，而 “最优” 的定义由目标函数来量化描述。

针对上述物块移动问题，常用的两个目标函数如下：

1.  **最小力平方**：

$$
\begin{align}
\underset{u(t),x(t),v(t)}{\min} \int_0^1u^2(\tau)d\tau
\end{align}
$$

该目标函数旨在最小化控制力的平方在整个运动过程中的积分，可理解为追求更 “平稳” 的控制力。

1.  **最小绝对功**：

$$
\begin{align}
\underset{u(t),x(t),v(t)}{\min} \int_0^1|u(\tau)v(\tau)|d\tau
\end{align}
$$

此目标函数致力于最小化控制力与速度乘积的绝对值的积分，侧重于减少运动过程中的能量消耗。

## 轨迹优化问题

### 目标函数

目标函数通常包含两部分

- 边界目标函数 $J(\cdot)$
- 整条轨迹的路径积分, 被积函数为 $\omega(\cdot)$

包含上述两项的问题称为 $Bolza$ 形式

仅包含积分部分的问题称为 $Lagrange$ 形式

仅包含边界部分的问题称为 $Mayer$ 形式

### 决策变量

在优化问题中，决策变量是指优化求解器 `solver` 可以调整或控制的变量，其取值直接影响目标函数（objective function）的结果。

求解器的核心任务就是通过寻找决策变量的最优组合，使目标函数达到最小值/最大值

常见的决策变量类型（以轨迹优化为例）

- 初始时间，结束时间 $(t_0,t_f)$
- 状态轨迹 $x(t)$ 和控制轨迹 $u(t)$

### 约束类型

优化会面临一系列的限制和约束，具体如下

1. 系统运动学

$$
\dot{x}(t)=f(t,x(t),u(t))
$$

    用于描述系统如何随时间变化，通常是非线性的

2. 路径约束

$$
h(t,x(t),u(t))\le 0
$$

    限定系统在整个过程（而非仅起点 / 终点） 中必须满足的条件，是对轨迹 “中间状态” 的约束

3. 非线性边界约束

   $$
   g(t_0,t_F, x(t_0),x(t_F))\le 0
   $$

   TODO: 没看明白这个约束作用

4. 状态与控制限制

$$
\begin{align}
&x_{low}\le x(t)\le x_{upp}\\
&u_{low}\le u(t)\le u_{upp}\\
\end{align}
$$

    对整个轨迹中状态变量和控制变量的取值范围施加简单的上下限约束

5. 初始与最终时间限制

$$
t_{low} \le t_0 \le t_F \le t_{upp}
$$

6. 初始与最终状态限制

$$
\begin{align}
&x_{0,low} \le x(t_0)\le x_{0,upp}\\
&x_{F,low} \le x(t_F) \le x_{F,upp}\\
\end{align}
$$

## 直接配点法

轨迹优化问题的求解方法可分为两大类：

- 间接法（Indirect Methods）
- 直接法（Direct Methods）

直接法的关键特征在于它将轨迹优化问题本身离散化，通常将原始轨迹优化问题转化为非线性规划。

## 非线性规划

大多数直接配点法将连续时间轨迹优化问题转化为非线性规划。非线性规划是指目标函数或约束函数中含有非线性项的受约束参数优化问题。非线性规划的典型公式如下：

$$
\begin{align}
&\underset {\mathrm{z}}{min}J(\mathrm{z})\\
&subject\quad to\\
& \quad f(\mathrm{z})=0,\\
& \quad g(\mathrm{z})=0,\\
& \mathrm{z}_{low} \le \mathrm{z} \le z_{upp}
\end{align}
$$

在某些情况下，直接配点法可能会产生线性或二次规划，而不是非线性规划。当约束（包括系统动力学）为线性且目标函数为线性（线性规划）或二次（二次规划）时，就会发生这种情况。线性和二次规划都比非线性规划更容易求解，因此它们非常适合实时应用，尤其是在机器人技术领域。
