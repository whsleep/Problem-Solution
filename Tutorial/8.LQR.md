## 动力学

- 状态：$\mathrm{x}=[x, y, \theta]^T$
- 控制输入：$\mathrm{u}=[v, \beta]^T$

**状态更新公式：**

$$
\begin{aligned} \dot{x} &= v \cos(\theta) \\ 
\dot{y} &= v \sin(\theta) \\ 
\dot{\theta} &= \frac{vtan(\beta)}{l}  \\ 
\end{aligned}
$$

矩阵格式为：

$$
\begin{aligned}
\dot{\mathrm{x}}= 
\begin{bmatrix}
cos(\theta)&0\\
sin(\theta)&0\\
\frac{tan(\beta)}{l}&0
\end{bmatrix}
\begin{bmatrix}
v\\
\beta
\end{bmatrix}
\end{aligned}
$$

即 $\dot{\mathrm{x}}=A\mathrm{x}+B\mathrm{u}\quad A=0$

## LQR 横向控制器（LQRLateralController）

LQR 是一种最优控制方法，它通过最小化一个**二次代价函数**来计算最优控制输入。该控制器主要负责计算**转向角（steer\_cmd）**

### 状态空间模型与线性化

LQR 的基础是**线性时不变系统**。对于路径跟踪问题，我们需要定义一个**误差状态**：

$$\mathbf{x}_e = \begin{bmatrix} y_e \\ \theta_e \end{bmatrix}$$

其中：

  * $y_e$：**横向误差 (Lateral Error)**，车辆到参考路径的垂直距离。
  * $\theta_e$：**航向误差 (Heading Error)**，车辆航向角 $\theta_e=\theta-\theta_{ref}$

将车辆的非线性运动学模型在参考点附近进行**线性化**，可以得到如下的误差状态空间模型：

$$
\dot{\mathbf{x}}_e \approx \mathbf{A} \mathbf{x}_e + \mathbf{B} \mathbf{u}
$$

$\mathbf{A}$ 矩阵描述了**误差状态** $\mathbf{x}_e$ 在没有控制输入时的演变。它依赖于 $\dot{y}_e$ 对 $\theta_e$ 的偏导数和 $\dot{\theta}_e$ 对 $y_e, \theta_e$ 的偏导数。

* $\dot{y}_e \approx v \sin(\theta_e) \approx v \theta_e$
* $\dot{\theta}_e = \dot{\theta} - \dot{\theta}_{\text{ref}}$

在线性化后，$\mathbf{A}$ 矩阵保持不变：

$$
\mathbf{A} = \begin{bmatrix} \frac{\partial \dot{y}_e}{\partial y_e} & \frac{\partial \dot{y}_e}{\partial \theta_e} \\ \frac{\partial \dot{\theta}_e}{\partial y_e} & \frac{\partial \dot{\theta}_e}{\partial \theta_e} \end{bmatrix} = \begin{bmatrix} 0 & v \\ 0 & 0 \end{bmatrix}
$$


$\mathbf{B}$ 矩阵描述了**LQR 控制输入 $\beta$** 对误差变化率 $\dot{\mathbf{x}}_e$ 的影响。

$$\mathbf{B} = \begin{bmatrix} \frac{\partial \dot{y}_e}{\partial \beta} \\ \frac{\partial \dot{\theta}_e}{\partial \beta} \end{bmatrix}$$

1.  **对 $\dot{y}_e$ 的影响：**
    $\dot{y}_e$ 在线性化模型中不直接依赖于转向角 $\beta$。
    $$\frac{\partial \dot{y}_e}{\partial \beta} = 0$$

2.  **对 $\dot{\theta}_e$ 的影响：**
    我们对 $\dot{\theta}$ 在 $\beta$ 处进行线性化：
    $$
    \frac{\partial \dot{\theta}}{\partial \beta}  = \frac{\partial}{\partial \beta} \left( \frac{v \tan(\beta)}{l} \right) = \frac{v}{l \cos^2(\beta)} 
    $$

因此，$\mathbf{B}$ 矩阵为：

$$\mathbf{B} = \begin{bmatrix} 0 \\ \frac{v}{l \cos^2(\beta)} \end{bmatrix}$$

### 代价函数

使用代价函数衡量系统的性能，定义为误差 $\mathrm{x}_e$ 和控制输入的 $\mathrm{u}$ 的加权和

$$
J=\int(\mathrm{x}_e^TQ\mathrm{x}_e+u^TRu)dt
$$

其中，$Q$ 和 $R$ 是正定矩阵，分别表示误差和控制输入的加权

### 计算最优控制器

LQR 算法的目标是寻找一个最优控制器，使得代价函数 $J$ 最小化。最优控制器可以表示为线性状态反馈控制器：

$$
u=-K\mathrm{x}_e
$$

其中， $K$ 是状态反馈矩阵，需要通过计算得到。将上述控制器代入状态空间模型中，可以得到：

$$
\begin{aligned}
\dot{\mathbf{x}}_e &= \mathbf{A} \mathbf{x}_e - K \mathbf{B} \mathbf{x}_e\\
\dot{\mathbf{x}}_e &= (\mathbf{A} - K \mathbf{B})\mathbf{x}_e
\end{aligned}
$$

继续代入到代价函数中

$$
\begin{aligned}
J=\int(\mathrm{x}_e^TQ\mathrm{x}_e+\mathrm{x}_e^TK^TRK\mathrm{x}_e)dt
\end{aligned}
$$

令 $K=R^{-1}B^TP$

$P$ 通过黎卡提方程 (ARE)求解

$$
A^TP+PA-PBR^{-1}B^TP+Q=0
$$

最终可以得到 $K$ 进而得到最优控制律

$$
u^*=-K\mathrm{x}_e
$$

