# MPC

## 运动学模型

平面坐标下可用 $x=[x,y,\theta]^T$ 描述状态

- $x,y$ 为车辆相对全局坐标系位置
- $\theta$ 车辆方位角(车辆朝向与全局水平轴的夹角)

控制输入 $u=[v,\omega]^T$

- $v$ 为车辆朝向方向的线速度
- $\omega$ 为相对车辆坐标系自身旋转角速度

运动学模型描述为

$$
\begin{align}
\dot{x}&=vcos\theta\\
\dot{y}&=vsin\theta\\
\dot{\theta}&=\omega\\
\end{align}
$$

矩阵形式为

$$
\dot{x}=
\left[
\begin{matrix}
cos\theta & 0\\
sin\theta  & 0\\
0 & 1
\end{matrix}
\right]
\left[
\begin{matrix}
v \\
\omega \\
\end{matrix}
\right]
$$

简写为

$$
\dot{x}=f(x,u)
$$

离散为差分方程形式

$$
x(k+1)=x(k)+\Delta T
\left[
\begin{matrix}
cos\theta(k)v(k)\\
sin\theta(k)v(k)\\
\omega(k)
\end{matrix}
\right]
$$

$\Delta T$ 为$k+1$和$k$时刻时间差。

## (Optimal Control Problem)OCP 问题

首先考虑连续系统，给定以下条件

- $\mathrm{x_s},\mathrm{x_f}$ 为起始状态和终止状态
- $t_s,t_f$ 起始时间和终止状态

对于 $t$ 时刻的各个状态和运动学方程可表示为

$$
\begin{align}
&\mathrm{x(t)}\\
&\mathrm{u(t)}\\
&\dot{\mathrm{x}}(t)=f\big(\mathrm{x(t)},\mathrm{u(t)}\big)
\end{align}
$$

优化的目的是通过控制输入，使车辆从起始状态逼近目标状态

而且期望这个过程中产生的所有$u$和$x$均遵守约束，

OCP 问题可描述为

$$
\begin{align}
&\underset {\mathrm{u}(t),\mathrm{x}(t),t_f}{min} J_f\big(\mathrm{x(t_f)}\big)+\int_{t=t_s}^{t_f} l\big(\mathrm{x}(t),\mathrm{u}(t)\big)dt\\
&\mathrm{subject~to}\\
&\qquad \mathrm{x}(t_s)=\mathrm{x}_s,\quad\mathrm{x}(t_f)=\mathrm{x}_f\\
&\qquad \dot{\mathrm{x}}(t)=f\big(\mathrm{x(t)},\mathrm{u(t)}\big)\\
&\qquad \mathrm{u(t)}\in \mathrm{U}, \quad t_f\in T
\end{align}
$$

- $\mathrm{U}$ 为控制变量可行集合
- $T$ 为时间约束

然而计算机无法求解连续问题，所以可以将其转化为一个 NLP 问题求解

## (nonlinear optimization problem)NLP 问题

$$
\begin{align}
&\underset{\Delta t_0, \Delta t_1,...,\Delta t_{N-1}}
{\underset{\mathrm{x}[0],\mathrm{x}[1],...,\mathrm{x}[N]}{\underset{\mathrm{u}[0],\mathrm{u}[1],...,\mathrm{u}[N-1]}
{min}}}
 J_f\big(\mathrm{x[N]}\big)+\sum_{k=0}^{N-1} l\big(\mathrm{x}[k],\mathrm{u}[k]\big)\Delta t_k\\
&\mathrm{subject~to}\\
&\qquad \mathrm{x}[0]=\mathrm{x}_s,\quad\mathrm{x}[N]=\mathrm{x}_f\\
&\qquad \big(\mathrm{u}[k+1]-\mathrm{u}[k+1]\big)\Delta t^{-1}\in\mathrm{U_d}\\
&\qquad \mathrm{u[k]}\in \mathrm{U}\\
&\qquad \Delta t_{min} \le\Delta t_0 \le \Delta t_{max}, \quad \Delta t_k = \Delta t_{k+1}\\
&\qquad \phi(\mathrm{x}[k+1], \mathrm{x}[k], \mathrm{u}[k], \Delta t_k)=0,\quad k=0,1,...,N-1
\end{align}
$$

- $\mathrm{U}_d$ 为控制变量一阶导数(对$t$)的可行集合
- $\Delta t _{min} \le\Delta t_0 \le \Delta t _{max}$ 为时间差的可行范围，$\Delta t_k = \Delta t_{k+1}$ 即表明所有$\Delta t$ 相等
- $\phi(\mathrm{x}_{k+1}, \mathrm{x}_k, \mathrm{u}_k, \Delta t_k)=0$ 为运动学约束，表明在 $\mathrm{x}_{k}$ 通过输入 $\mathrm{u}_k$ 再经过 $\Delta t_k$ 后 一定可以转换为 $\mathrm{x}_{k+1}$，否则即不满足运动学约束

> 这里涉及 Single Shooting & Multi-Shooting 方法

- Single Shooting

优化变量 $=\{\mathrm{u}[0],\mathrm{u}[1],...,\mathrm{u}[N-1]\}$

状态序列 $\mathrm{x}[0],\mathrm{x}[1],...,\mathrm{x}[N]$ 通过前向差分 $\mathrm{x}[k+1]=\mathrm{x}[k]+f\big(\mathrm{x}[k], \mathrm{u}[k]\big)\Delta t_k$一次性算出来，不作为变量

- Multiple Shooting

优化变量 $=\{\mathrm{x}[0],\mathrm{x}[1],...,\mathrm{x}[N],\mathrm{u}[0],\mathrm{u}[1],...,\mathrm{u}[N-1]\}$

每段区间独立，再通过 $\phi(\mathrm{x}[k+1], \mathrm{x}[k], \mathrm{u}[k], \Delta t_k)=0$ 将轨迹序列焊接成连续可行轨迹

由于这里的规划问题是一个 **非线性时不变系统** 所以选择 **Multiple Shooting** 进行优化

### 运动学约束

- C. Rösmann, A. Makarow, and T. Bertram: Online Motion Planning based on Nonlinear Model Predictive Control with Non-Euclidean Rotation Groups, [arXiv:2006.03534 '[cs.RO]'](https://arxiv.org/abs/2006.03534), June 2020.

论文中提供了两种 **Multiple Shooting** 计算方式，为了便于理解，这里选择前向欧拉差分形式

$$
\begin{align}
\phi(\mathrm{x}[k+1], \mathrm{x}[k], \mathrm{u}[k], \Delta t_k)=\frac{\mathrm{x}[k+1]- \mathrm{x}[k]}{\Delta t_k}-f\big(\mathrm{x}[k], \mathrm{u}[k]\big)
\end{align}
$$

### 目标函数

考虑到终端误差的目标函数为

$$
\begin{align}
J_f\big(\mathrm{x[N]}\big)&=(\mathrm{x}[N]-\mathrm{x}_f)^T\mathrm{Q}_f(\mathrm{x}[N]-\mathrm{x}_f)\\
l\big(\mathrm{x}[k],\mathrm{u}[k]\big)&=(\mathrm{x}[k]-\mathrm{x}_f)^T\mathrm{Q}(\mathrm{x}[k]-\mathrm{x}_f)+\mathrm{u}[k]^TR\mathrm{u}[k]\\
\end{align}
$$

## 参考

- [(附代码)轨迹优化中的 shooting/collocation 方法小结](https://www.zhihu.com/people/yang-tai-wen-24/posts)

- [CasADi 学习(2)](https://zhuanlan.zhihu.com/p/149304322)

- C. Rösmann, A. Makarow, and T. Bertram: Online Motion Planning based on Nonlinear Model Predictive Control with Non-Euclidean Rotation Groups, [arXiv:2006.03534 '[cs.RO]'](https://arxiv.org/abs/2006.03534), June 2020.
