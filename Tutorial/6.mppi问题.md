# MPPI

## 预定义

考虑一个非线性时不变离散系统，

$$
\mathrm{x}=\mathrm{F}(\mathrm{x}_t,\mathrm{v}_t)
$$

- $\mathrm{x}_t\in\mathbb{R}^n$ 表示系统在$t$时刻状态
- $\mathrm{v}_t\in\mathbb{R}^m$ 表示系统在$t$时刻输入
- $\mathrm{F}$ 表示系统的状态转移函数

$t\in\{0,1,...,T-1\}$

不同之处在与， $\mathrm{v}_t$ 不是直接的输入变量，而是由白噪声生成的随机变量

$$
\mathrm{v}_t \sim \mathit{N}(\mathrm{u}_t,\Sigma)
$$

在系统中添加认为噪声也是促进探索可能性的方式，现在给定一个输入序列:

$$
(\mathrm{v}_0,\mathrm{v}_1,...,\mathrm{v}_{T-1} )=V\in \mathbb{R}^{m\times T}
$$

与之对应的期望序列为

$$
(\mathrm{u}_0,\mathrm{u}_1,...,\mathrm{u}_{T-1} )=U\in \mathbb{R}^{m\times T}
$$

控制序列 $V$ 的概率密度函数表示为

$$
\begin{align}
q(V|U,\Sigma)&=\prod_{t=0}^{T-1}Z^{-1}exp\left( -\frac{1}{2}(\mathrm{v}_t-\mathrm{u}_t)^T\Sigma^{-1}(\mathrm{v}_t-\mathrm{u}_t)\right)\\
&=Z^{-T}exp\left(-\frac{1}{2}\sum_{t=0}^{T-1}(\mathrm{v}_t-\mathrm{u}_t)^T\Sigma^{-1}(\mathrm{v}_t-\mathrm{u}_t)\right)
\end{align}
$$

- $Z=((2\pi)^m|\Sigma|)^{\frac{1}{2}}$
- $q(V|U,\Sigma)$ 对应的分布为 $\mathbb{Q}_{U,\Sigma}$

> 当时间步长 $T = 1$ 时，控制序列 $V$ 和均值序列 $U$ 都退化为**单个向量**，即：
>
> $$
> V = [v_0], \quad U = [u_0]
> $$
>
> 此时，分布 $q(V|U,\Sigma)$ 的表达式简化为：
>
> $$
> q(V|U,\Sigma) = Z^{-1} \exp\left( -\frac{1}{2}(v_0 - u_0)^\top \Sigma^{-1}(v_0 - u_0) \right)
> $$
>
> 其中：
>
> - $Z = \left((2\pi)^m |\Sigma|\right)^{1/2}$ 是正态分布的归一化常数。
> - $m$ 是控制输入的维度（例如，转向角和加速度，则 $m = 2$）。
> - $\Sigma$ 是协方差矩阵，表示控制输入的噪声强度。
>
> **具体计算步骤（T=1）**
>
> 1.  **输入参数**：
>
> - 控制输入维度 $m = 2$（转向角 $\delta$，加速度 $a$）。
> - 协方差矩阵 $\Sigma = \begin{bmatrix} \sigma_\delta^2 & 0 \\ 0 & \sigma_a^2 \end{bmatrix}$。
> - 期望 $u_0 = [\delta_{\text{mean}}, a_{\text{mean}}]^\top$。
> - 随即变量 $v_0 = [\delta_{\text{sample}}, a_{\text{sample}}]^\top$。
>
> 2.  **计算马氏距离**：
>     $$
>     d^2 = (v_0 - u_0)^\top \Sigma^{-1}(v_0 - u_0) = \frac{(\delta_{\text{sample}} - \delta_{\text{mean}})^2}{\sigma_\delta^2} + \frac{(a_{\text{sample}} - a_{\text{mean}})^2}{\sigma_a^2}
>     $$
> 3.  **计算归一化常数 $Z$**：
>     $$
>     |\Sigma| = \sigma_\delta^2 \cdot \sigma_a^2 \implies Z = \sqrt{(2\pi)^2 \cdot \sigma_\delta^2 \sigma_a^2} = 2\pi \sigma_\delta \sigma_a
>     $$
> 4.  **最终概率密度**：
>     $$
>     q(V|U,\Sigma) = \frac{1}{2\pi \sigma_\delta \sigma_a} \exp\left( -\frac{1}{2} \left[ \frac{(\delta_{\text{sample}} - \delta_{\text{mean}})^2}{\sigma_\delta^2} + \frac{(a_{\text{sample}} - a_{\text{mean}})^2}{\sigma_a^2} \right] \right)
>     $$

给定代价函数 $\mathrm{L}(\mathrm{x}_t,\mathrm{u}_t)$ 和终端代价函数 $\phi(\mathrm{x}_T)$, OCP 问题可描述为

$$
U^*=\underset{U\in\mathcal{U}}{argmin} \mathbb{E}_{\mathbb{Q}_{U,\Sigma}}\bigg[ \phi(\mathrm{x}_T)+\sum_{t=0}^{T-1} \mathrm{L}(\mathrm{x}_t,\mathrm{u}_t)  \bigg]
$$

- $\mathcal{U}$ 为控制输入的可行域

代价函数可继续描述为

$$
\mathrm{L}(\mathrm{x}_t,\mathrm{u}_t)=c(\mathrm{x}_t)+\frac{\lambda}{2}(\mathrm{u}_t^T\Sigma\mathrm{u}_t+\beta_t^T\mathrm{u}_t)
$$

假设有一状态序列 $\mathrm{x}_0,\mathrm{x}_1,...,\mathrm{x}_T$ 构成的轨迹,则该轨迹的代价可表示为

$$
C(\mathrm{x}_0,\mathrm{x}_1,...,\mathrm{x}_T)=\phi(\mathrm{x}_T)+\sum^{T-1}_{t=0}C(\mathrm{x}_t)
$$

而状态序列可由控制序列 $V$ 和初始状态 $\mathrm{x}_0$ 生成

$$
\mathcal{H}(V;\mathrm{x}_0)=(\mathrm{x}_0.\mathrm{F}(\mathrm{x}_0,v_0),\mathrm{F}(\mathrm{F}(\mathrm{x}_0,v_0),v_1),...)
$$

所以由状态序列 $V$ 生成轨迹代价表示为

$$
S(V;x_0)=C(\mathcal{H}(V;\mathrm{x}_0))
$$

当 $\mathrm{x}_0$ 确定时可简写为 $S(V)$

定义自由能公式：

$$
\mathcal{F}(S,p,\mathrm{x}_0,\lambda) =  \log \mathbb{E}_{\mathbb{P}}\left[ \exp\left(-\frac{S(V)}{\lambda}\right) \right]
$$

用于将随机最优控制问题转化为概率推断问题。它的作用是： 将控制问题的“**代价最小化**”转化为“**概率分布的优化**”，从而可以用采样的方法求解。

因为“代价小”≈“轨迹好”，而“轨迹好”≈“概率高”。
指数函数 exp(−x) 天然地把“越小越好的量”变成“越大越好的概率”。

- $\lambda$ 用于调节轨迹代价对概率的影响
- $log$ 函数这里主要是用于稳定数值
- $p(V)$ 只是一个可自由设定的“基准”分布，通常选 $\mathbb{P}=\mathbb{Q}_{0,\Sigma}$

另外定义两个绝对连续的分布 $\mathbb{F},\mathbb{H}$

**绝对连续**

> 两个分布 $\mathbb{F}$ 与 \mathbb{H} 必须满足：
> “如果 $\mathbb{F}$ 在某处概率为 0，则 $\mathbb{H}$ 在该处也必须为 0，反之亦然”。

这两个分布之间的 KL 散度为

$$
\mathbb{D}_{KL}(\mathbb{F}||\mathbb{H})=\mathbb{E}_\mathbb{F}\big[log(\frac{f(V)}{h(V)})\big]
$$

## 自由能推导

考虑 $\mathbb{P}$ 和 $\mathbb{Q}_{U,\Sigma}$ 绝对连续, 使用重要性采样后:

$$
\begin{align}
&\mathcal{F}(S,p,\mathrm{x}_0,\lambda) =  \log \mathbb{E}_{\mathbb{P}}\left[ \exp\left(-\frac{S(V)}{\lambda}\right) \right]\\
&=\log\mathbb{E}_{\mathbb{Q}_{U,\Sigma}}\left[ \exp\left(-\frac{S(V)}{\lambda}\right) \frac{p(V)}{q(V|U,\Sigma)} \right]
\end{align}
$$

$Jensen$ 不等式

$$
\mathcal{F}(S,p,\mathrm{x}_0,\lambda) \ge\mathbb{E}_{\mathbb{Q}_{U,\Sigma}}\left[ \log\left(\exp\left(-\frac{S(V)}{\lambda}\right) \frac{p(V)}{q(V|U,\Sigma)} \right)\right]
$$

使用 $\log$ 性质进行简化

$$
\begin{align}
\mathcal{F}(S,p,\mathrm{x}_0,\lambda) &\ge
\mathbb{E}_{\mathbb{Q}_{U,\Sigma}}
\left[
-\frac{S(V)}{\lambda}
+
\log\left(\frac{p(V)}{q(V|U,\Sigma)}\right)
\right]\\
&\ge-\frac{1}{\lambda}
\mathbb{E}_{\mathbb{Q}_{U,\Sigma}}
\left[
S(V)
+
\lambda\log\left(\frac{q(V|U,\Sigma)}{p(V)}\right)
\right]\\
&\ge-\frac{1}{\lambda}\left(
\mathbb{E}_{\mathbb{Q}_{U,\Sigma}}
[S(V)]
+
\lambda\mathbb{D}_{KL}(\mathbb{Q}_{U,\Sigma}||\mathbb{P})
\right)
\end{align}
$$

进一步转换为

$$
-\lambda\mathcal{F}(S,p,\mathrm{x}_0,\lambda)
\le
\mathbb{E}_{\mathbb{Q}_{U,\Sigma}}
[S(V)]
+
\lambda\mathbb{D}_{KL}(\mathbb{Q}_{U,\Sigma}||\mathbb{P})
$$

方程左侧是负的 **逆温系数** 乘以系统的 **自由能** ，右侧是最优控制问题的 **状态成本** ，再加上基础分布（base distribution）与受控分布（controlled distribution）之间的 **KL 散度**

既要求状态接近目标（状态成本），又要求控制策略不过度偏离基准（KL 散度作为控制成本）

## 参考

[Information Theoretic Model Predictive Control: Theory and Applications to Autonomous Driving](https://arxiv.org/pdf/1707.02342)
